<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="http://static.hdslb.com/images/favicon.ico">
    <title>Bilibili System XFS</title>
    <!-- Bootstrap core CSS -->
    <link href="static/css/app2.css" rel="stylesheet">
<!--    <link href="css/dc.css" rel="stylesheet">-->

    <!-- <link rel="stylesheet" type="text/css" href="http://v3.bootcss.com/examples/carousel/carousel.css">
 -->
</head>
<script type="text/javascript" src="static/js/d3.js"></script>
<script type="text/javascript" src="static/js/crossfilter.js"></script>
<script type="text/javascript" src="static/js/dc.js"></script>
<script type="text/javascript" src="static/js/colorbrewer.js"></script>
<script src="static/bower_components/jquery/dist/jquery.js"></script>
<!-- NAVBAR
================================================== -->

<body>
    <div class="navbar-default">
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                    <a class="navbar-brand">
                        <img alt="Brand" src="http://static.hdslb.com/images/favicon.ico">
                    </a>
                    <a class="navbar-brand" href="index.html">B站检索系统</a>

                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav ">
                        <li class="active"><a href="index.html">首页</a></li>
                        <li><a href="index.html#system-info">数据说明</a></li>
                        <li><a href="index.html#scrapy">爬虫架构</a></li>
                        <li><a href="index.html#retrieval-model">检索模型</a></li>

                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">更多信息<span
                                    class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="http://www.bilibili.com/">哔哩哔哩</a></li>
                                <li><a href="http://snh48.com/">SNH48</a></li>
                                <li><a href="http://space.bilibili.com/26480852">SNH48 TEAM NII</a></li>
                                <li class="divider"></li>
                                <li class="dropdown-header">御三家 bilibili sp</li>
                                <li><a href="#">黄婷婷</a></li>
                                <li><a href="#">李艺彤</a></li>
                            </ul>
                        </li>

                    </ul>
                    <ul class="nav navbar-nav navbar-right">

                        <li><a href="#loginin">登陆</a></li>
                        <li><a href="#register">注册</a></li>

                    </ul>

                </div>
            </div>
        </nav>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <div class="page-header">
                    <h3>
                        {{result.h_title}}
				</h3>
                </div>
                <dl>
                    <dt>
					简介
				    </dt>
                    <dd>
                        {{result.description}}
                    </dd>
                    <dt>
					视频信息
				    </dt>
                   
        
                    <dd>
                        <buttom class="btn btn-info"><span class="glyphicon glyphicon-eye-open"></span> 播放{{result.view}}</buttom>
                        <buttom class="btn btn-info"><span class="glyphicon glyphicon-commen"></span>弹幕{{result.danmaku}}</buttom>
                        <buttom class="btn btn-info"><span class="glyphicon glyphicon-heart"></span> 硬币{{result.coin}}</buttom>
                        <buttom class="btn btn-info"><span class="glyphicon glyphicon-folder-open"></span> 收藏{{result.favorite}}</buttom>
                        
                    </dd>
                    
                    <dt>
					标签系统
				    </dt>
                   
        
                    <dd>
                    {% for ele in result.tag_list%}
                    <button class="btn btn-warning">{{ele|safe}}</button>
                    
                    {%endfor%}
                        
                    </dd>
                    
                    <dt>
					上传时间
				</dt>
                    <dd>
                       {{result.date}}
                    </dd>
                     <dt>
                    抓取时间
                </dt>
                    <dd>
                       {{result.crawl_time}}
                    </dd>
                    <dt>
					视频
				</dt>
                    <dd>
                        <embed height="400" width="550" quality="high" allowfullscreen="true" type="application/x-shockwave-flash" src="http://static.hdslb.com/miniloader.swf" flashvars="aid={{result.aid}}&page={{result.page}}" pluginspage="http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash"></embed>
                    </dd>
                </dl>
            </div>
            <div class="col-md-6 my-dc-charts">
                <div class="row">
                    <div class="col-md-12">
                        <div id="danmu-bar">
                        </div>
                        <p class="muted pull-right">select a time range to zoom in</p>
                    </div>

                    <div class="col-md-12">
                        <div id="monthly-move-chart">
                            <span class="reset" style="display: none;">range: <span class="filter"></span></span>
                            <a class="reset" href="javascript:dc.filterAll();;dc.redrawAll();" style="display: none;">reset</a>
                        </div>
                    </div>
                    <div class="col-md-12">
                    <div class="row">
                        <div id="quarter-chart" >
                            <strong>颜色分布情况</strong>
                        </div>
                        <div id="quarter2-chart">
                            <strong>位置分布情况</strong>
                        </div>
                    </div>
                        
                    </div>
                </div>
            </div>
        </div>
        <div class="row">

            <div class="row">
                <div class="col-md-12">
                <h3>弹幕部分列表</h3>
                    <div class="dc-data-count">
                        <span class="filter-count"></span> selected out of <span class="total-count"></span> records | <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
                    </div>
                    <table class="table table-hover dc-data-table">
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row col-md-12">
        <footer class="container">
            <p class="pull-right"><a href="#">Back to top</a></p>
            <p>&copy; 2016 黄俊杰. &middot; <a href="#">Privacy</a> &middot; <a href="#">Terms</a></p>
        </footer>

    </div>


    </div>

    <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
    <script src="static/bower_components/bootstrap-sass/assets/javascripts/bootstrap.js"></script>
    <script type="text/javascript">
        function print_filter(filter) {
            var f = eval(filter);
            if (typeof (f.length) != "undefined") {} else {}
            if (typeof (f.top) != "undefined") {
                f = f.top(Infinity);
            } else {}
            if (typeof (f.dimension) != "undefined") {
                f = f.dimension(function (d) {
                    return "";
                }).top(Infinity);
            } else {}
            console.log(filter + "(" + f.length + ") = " + JSON.stringify(f).replace("[", "[\n\t").replace(/}\,/g, "},\n\t").replace("]", "\n]"));
        }

        var time_cut = 50;

        var row_width = $(".row>div").width();
        d3.csv("/static/csv_dir/{{cid}}.csv", function (error, csv_data) {
            var Barchart = dc.barChart('#danmu-bar');
            var LineChart = dc.lineChart('#monthly-move-chart');
            var nasdaqTable = dc.dataTable('.dc-data-table');
            var nasdaqCount = dc.dataCount('.dc-data-count');
            var quarterChart = dc.pieChart('#quarter-chart');
            var quarter2Chart = dc.pieChart('#quarter2-chart');
            
            var data = [];


            var video_len = parseFloat(csv_data[1].video_len);
            console.log(video_len);
            for (var i = 0; i < csv_data.length; i++) {
                csv_data[i].show_time = +csv_data[i].show_time
                data.push({
                    show_time: csv_data[i].show_time,
                    video_ratio: csv_data[i].show_time / video_len,
                    cls: parseInt(csv_data[i].show_time / video_len * time_cut) / time_cut,
                    content: csv_data[i].content,
                    font_size: csv_data[i].font_size,
                    color: csv_data[i].color,
                    submit_time: csv_data[i].submit_time,
                    danmu_type: csv_data[i].cls
                })
            }


            var ndx = crossfilter(data);
            // print_filter(ndx)
            var all = ndx.groupAll();

            var cls = ndx.dimension(function (d) {
                return d.cls;
            });

            /* dc.lineChart('#monthly-move-chart', 'chartGroup') */

            var ratioGroup = cls.group().reduceSum(function (d) {
                return 1;
            });

            var quarter = ndx.dimension(function(d){
                return d.color;
            })

             var quarterGroup = quarter.group().reduceSum(function (d) {
                return 1;
            });

            var quarter2 = ndx.dimension(function(d){
                return d.danmu_type;
            })

             var quarterGroup2 = quarter2.group().reduceSum(function (d) {
                return 1;
            });


            print_filter(ratioGroup);
            
            quarterChart /* dc.pieChart('#quarter-chart', 'chartGroup') */
                .width(200)
                .height(200)
                .radius(80)
                .innerRadius(30)
                .dimension(quarter)
                .group(quarterGroup)
                .label(function(d){
                    var hex = function (x) {
                        return parseInt(x).toString(16);
                    }
                   
                    return "#"+hex(d.key);
                });
            
            quarter2Chart
                .width(200)
                .height(200)
                .radius(80)
                .dimension(quarter2)
                .group(quarterGroup2)

            Barchart
                .height(400)
                .width(row_width)
                .margins({
                    top: 0,
                    right: 50,
                    bottom: 40,
                    left: 40
                })
                .x(d3.scale.linear().domain([0, 1]))
                .brushOn(false)
                .rangeChart(LineChart)
                .yAxisLabel("弹幕数量")
                .xAxisLabel("弹幕出现视频比率")
                .xAxisPadding("10%")
                .dimension(cls)
                .group(ratioGroup)
                .gap(1)
                .xUnits(function () {
                    return time_cut;
                });

            LineChart
                .width(row_width)
                .height(150)
                .margins({
                    top: 0,
                    right: 50,
                    bottom: 20,
                    left: 40
                })
                .mouseZoomable(true)
                .x(d3.scale.linear().domain([0, 1]))
                .interpolate('basis')
                .renderArea(true)
                .brushOn(true)
                .renderDataPoints(false)
                .clipPadding(10)
                .dimension(cls)
                .group(ratioGroup)
                .elasticY(false)
                .yAxis().tickFormat(function (v) {
                    return ""
                });
            
            String.prototype.toHHMMSS = function () {
                var sec_num = parseInt(this, 10); // don't forget the second param
                var hours   = Math.floor(sec_num / 3600);
                var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
                var seconds = sec_num - (hours * 3600) - (minutes * 60);

                if (hours   < 10) {hours   = "0"+hours;}
                if (minutes < 10) {minutes = "0"+minutes;}
                if (seconds < 10) {seconds = "0"+seconds;}
                return hours+':'+minutes+':'+seconds;
            };

            nasdaqTable /* dc.dataTable('.dc-data-table', 'chartGroup') */
                .dimension(cls)
                // Data table does not use crossfilter group but rather a closure
                // as a grouping function
                .group(function (d) {
                    return "当前时间段：" + d.cls + "前50条弹幕信息";
                })
                // (_optional_) max number of records to be shown, `default = 25`
                .size(50)
                // There are several ways to specify the columns; see the data-table documentation.
                // This code demonstrates generating the column header automatically based on the columns.
                .columns([
                // Use the `d.date` field; capitalized automatically
                    {
                        label: 'ShowTime',
                        format: function (d) {
                            var num = new Number(d.show_time);
                            return num.toFixed(2).toHHMMSS();
                        }
                },
                // Use `d.open`, `d.close`
                    {
                        label: 'Color',
                        format: function (d) {
                            var hex = function (x) {
                                return parseInt(x).toString(16);
                            }

                            var return_svg = '<svg width="20" height="20"><rect width="30" height="20" style="fill:#';
                            return_svg = return_svg + hex(d.color) + '"></rect></svg>'
                            console.log(return_svg);
                            return return_svg;
                        }
                },
                'font_size', {
                        label: 'Content',
                        format: function (d) {
                            var return_str = '<p style="font-size:' + d.font_size * 0.5 + 'px;'
                            return_str = return_str + '">'
                            return_str = return_str + d.content + '</p>'
                            return return_str;
                        }
                }, {
                        label: "UpTime",
                        format: function (d) {
                            var d2 = new Date();
                            var format = d3.time.format("%Y-%m-%d");
                            console.log(parseInt(d.submit_time) + d2.getTimezoneOffset() * 60000);
                            var date = new Date(parseInt(d.submit_time) * 1000 + d2.getTimezoneOffset() * 60000)
                            return format(date);
                        }
                }

                // Use `d.volume`
            ])

            // (_optional_) sort using the given field, `default = function(d){return d;}`
            .sortBy(function (d) {
                    return d.show_time;
                })
                // (_optional_) sort order, `default = d3.ascending`
                .order(d3.ascending)
                // (_optional_) custom renderlet to post-process chart using [D3](http://d3js.org)
                .on('renderlet', function (table) {
                    table.selectAll('.dc-table-group').classed('info', true);
                });
            nasdaqCount /* dc.dataCount('.dc-data-count', 'chartGroup'); */
                .dimension(ndx)
                .group(all)
                // (_optional_) `.html` sets different html when some records or all records are selected.
                // `.html` replaces everything in the anchor with the html given using the following function.
                // `%filter-count` and `%total-count` are replaced with the values obtained.
                .html({
                    some: '<strong>%filter-count</strong> selected out of <strong>%total-count</strong> records' +
                        ' | <a href=\'javascript:dc.filterAll(); dc.renderAll();\'>Reset All</a>',
                    all: '当前视频所有的弹幕都被选择，可以进行筛选'
                });


            dc.renderAll();
        });
    </script>
</body>